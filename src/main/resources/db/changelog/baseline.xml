<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                   https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.3.xsd"
                   logicalFilePath="baseline.xml">

    <changeSet id="create-weather-schema" author="aleksei">
        <sql splitStatements="false">
            CREATE SCHEMA weather;
        </sql>
    </changeSet>

    <changeSet id="add-place-table" author="aleksei">
        <sql splitStatements="false">
            SELECT set_config('search_path', 'weather', true);

            CREATE TABLE place
            (
                id         INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                name       VARCHAR(100)             NOT NULL UNIQUE,
                created_at TIMESTAMP WITH TIME ZONE NOT NULL,
                created_by VARCHAR(63)              NOT NULL
            );
        </sql>
    </changeSet>

    <changeSet id="add-forecast-table" author="aleksei">
        <sql splitStatements="false">
            SELECT set_config('search_path', 'weather', true);

            CREATE TABLE forecast
            (
                id               INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                date             DATE                       NOT NULL,
                time_of_day      VARCHAR(5)                NOT NULL CHECK (time_of_day IN ('DAY', 'NIGHT')),
                phenomenon       VARCHAR(50),
                temp_min         SMALLINT,
                temp_max         SMALLINT,
                text_description TEXT,
                peipsi           TEXT,
                created_at       TIMESTAMP WITH TIME ZONE NOT NULL,
                created_by       VARCHAR(63)              NOT NULL,
                ---
                CHECK ( temp_max > forecast.temp_min )
            );

            CREATE UNIQUE INDEX unique_forecast_date_time ON forecast (date, time_of_day);
        </sql>
    </changeSet>

    <changeSet id="add-place-forecast-table" author="aleksei">
        <sql splitStatements="false">
            SELECT set_config('search_path', 'weather', true);

            CREATE TABLE place_forecast
            (
                id          BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                place_id    INT references place (id),
                forecast_id INT references forecast (id),
                phenomenon  VARCHAR(50),
                temp_min    SMALLINT,
                temp_max    SMALLINT,
                created_at  TIMESTAMP WITH TIME ZONE NOT NULL,
                created_by  VARCHAR(63)              NOT NULL,
                ---
                CONSTRAINT check_temperature_exists CHECK (temp_min IS NOT NULL OR temp_max IS NOT NULL)
            );
        </sql>
    </changeSet>


</databaseChangeLog>